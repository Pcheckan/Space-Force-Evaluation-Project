// ================================================================================================
// This is the file that contains the connections to each of the collections that are necessary 
// to generate and store surveys in the database. This file also contains the tasks necessary,
// to generate and store surveys in the database.
// ================================================================================================
using Microsoft.Extensions.Caching.Memory;
namespace SpaceForceEvaluationAppLibrary.DataAccess;

public class MongoSurveyData : ISurveyData
{
    private readonly IMongoCollection<SurveyModel> _surveys;
    private readonly IUserData _userData;
    private readonly IDbConnection _db;
    private readonly IMemoryCache _cache;
    private const string CacheName = "SurveyData";

    // here is the constructor that makes the connection to the database and makes
    // and initializes a connection to the SurveyCollection in the database.
    public MongoSurveyData(IDbConnection db, IUserData userData, IMemoryCache cache)
    {
        _userData = userData;
        _db = db;
        _cache = cache;
        _surveys = db.SurveyCollection;
    }

    // Here is the task that genereates todays survey.
    // TODO: don't know if actually works or needs caching??? figure out later.
    public async Task<List<SurveyModel>> GetTodaysSurveys()
    {
        var output = _cache.Get<List<SurveyModel>>(CacheName);
        if (output is null)
        {
            var results = await _surveys.FindAsync(s => s.isArchived == false);
            output = results.ToList();

            _cache.Set(CacheName, output, TimeSpan.FromMinutes(3));
        }
        return output;
    }

    // Here is the task that gets all past surveys.
    // TODO: don't actually know if this requires caching.
    public async Task<List<SurveyModel>> GetAllPastSurveys()
    {
        var output = _cache.Get<List<SurveyModel>>(CacheName);
        if (output is null)
        {
            var results = await _surveys.FindAsync(s => s.isArchived == true);
            output = results.ToList();

            _cache.Set(CacheName, output, TimeSpan.FromMinutes(5));
        }
        return output;
    }

    // Here is the task that returns a specific survey by searching for the
    // surveyID string.
    // TODO: update string variable so it doesnt search for the autogenerated object id,
    // unless that works better??? test later.
    public async Task<SurveyModel> GetSurvey(string id)
    {
        var results = await _surveys.FindAsync(s => s.Id == id);
        return results.FirstOrDefault();
    }

    // here is the task that updates the survey passed into the task.
    public async Task UpdateSurvey(SurveyModel survey)
    {
        await _surveys.ReplaceOneAsync(s => s.Id == survey.Id, survey);
        _cache.Remove(CacheName);
    }

    // this is the big one update later to add all functionality
    public Task CreateSurvey(SurveyModel survey)
    {
        return _surveys.InsertOneAsync(survey);
    }
}
